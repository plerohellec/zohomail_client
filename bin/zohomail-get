#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"
require "dotenv"
require "optparse"
require "json"
require "html2text"

Dotenv.load
ZohomailClient.configure do |config|
  config.client_id = ENV["ZOHOMAIL_CLIENT_ID"]
  config.client_secret = ENV["ZOHOMAIL_CLIENT_SECRET"]
  config.refresh_token = ENV["ZOHOMAIL_REFRESH_TOKEN"]
  config.account_id = ENV["ZOHOMAIL_ACCOUNT_ID"]
end

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: zohomail-get [options] <message_id>"

  opts.on("--folder-id FOLDER_ID", "Folder ID (default: from ZOHOMAIL_INBOX_FOLDER_ID env)") do |folder_id|
    options[:folder_id] = folder_id
  end

  opts.on("--format FORMAT", ["text", "json"], "Output format: text or json (default: text)") do |format|
    options[:format] = format
  end

  opts.on("--trim-html", "Convert HTML content to plain text") do
    options[:trim_html] = true
  end

  opts.on("-h", "--help", "Show this help") do
    puts opts
    exit
  end
end.parse!

message_id = ARGV.shift
unless message_id
  $stderr.puts "Error: message_id is required"
  puts "Usage: zohomail-get [options] <message_id>"
  exit 1
end

folder_id = options[:folder_id] || ENV["ZOHOMAIL_INBOX_FOLDER_ID"]
format = options[:format] || "text"

unless folder_id
  puts "Error: folder_id is missing. Provide it as --folder-id or set ZOHOMAIL_INBOX_FOLDER_ID in .env"
  exit 1
end

begin
  client = ZohomailClient.client

  unless format == "json"
    puts "Fetching content for message #{message_id} in folder #{folder_id}..."
  end
  response = client.get_message_content(folder_id, message_id)

  # Convert HTML to text if requested
  if response["data"] && response["data"].is_a?(Hash) && response["data"]["content"]
    if options[:trim_html]
      response["data"]["content"] = Html2Text.convert(response["data"]["content"])
    end

    if format == "json"
      puts response["data"].to_json
    else
      puts "Content:"
      puts "-" * 40
      puts response["data"]["content"]
      puts "-" * 40
    end
  else
    if format == "json"
      puts {}.to_json
    else
      $stderr.puts "Error or no content found: #{response}"
    end
    exit 1
  end
rescue ZohomailClient::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
end
