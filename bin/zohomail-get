#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"

begin
  client = ZohomailClient.client_from_env

  if ARGV[0] == "--help"
    puts "Usage: zohomail-get <message_id> [folder_id]"
    puts "If folder_id is not provided, it uses ZOHOMAIL_FOLDER_ID from .env"
    exit 0
  end

  if ARGV.length == 1
    message_id = ARGV[0]
    folder_id = ENV["ZOHOMAIL_FOLDER_ID"]
  elsif ARGV.length >= 2
    folder_id = ARGV[0]
    message_id = ARGV[1]
  elsif ARGV.length == 0
    puts "Usage: zohomail-get <message_id> [folder_id]"
    puts "If folder_id is not provided, it uses ZOHOMAIL_FOLDER_ID from .env"
    exit 1
  end

  unless folder_id
    puts "Error: folder_id is missing. Provide it as an argument or set ZOHOMAIL_FOLDER_ID in .env"
    exit 1
  end

  puts "Fetching content for message #{message_id} in folder #{folder_id}..."
  response = client.get_message_content(folder_id, message_id)

  if response["data"] && response["data"].is_a?(Hash) && response["data"]["content"]
    puts "Content:"
    puts "-" * 40
    puts response["data"]["content"]
    puts "-" * 40
  elsif response["data"] && response["data"].is_a?(Array)
    # This shouldn't happen based on docs, but just in case
    puts "Received unexpected Array format."
    if response["data"].first && response["data"].first["content"]
      puts "First item content:"
      puts response["data"].first["content"]
    end
  else
    puts "Error or no content found: #{response}"
    exit 1
  end
rescue ZohomailClient::Error => e
  puts "Error: #{e.message}"
  exit 1
end
