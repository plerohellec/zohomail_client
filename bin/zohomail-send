#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"
require "dotenv"
require "optparse"

Dotenv.load
ZohomailClient.configure do |config|
  config.client_id = ENV["ZOHOMAIL_CLIENT_ID"]
  config.client_secret = ENV["ZOHOMAIL_CLIENT_SECRET"]
  config.refresh_token = ENV["ZOHOMAIL_REFRESH_TOKEN"]
  config.account_id = ENV["ZOHOMAIL_ACCOUNT_ID"]
end

options = {
  format: "plaintext"
}

opt_parser = OptionParser.new do |opts|
  opts.banner = "Usage: zohomail-send [options]"

  opts.on("-t", "--to EMAIL", "Recipient email address") { |v| options[:to] = v }
  opts.on("-s", "--subject SUBJECT", "Email subject") { |v| options[:subject] = v }
  opts.on("-c", "--content CONTENT", "Email content (interprets \\n as newline)") { |v| options[:content] = v }
  opts.on("-f", "--from EMAIL", "Sender email address") { |v| options[:from] = v }
  opts.on("--format FORMAT", ["html", "plaintext"], "Email format (html or plaintext, default: plaintext)") { |v| options[:format] = v }

  opts.on("--draft", "Send as draft") { options[:is_draft] = true }
  opts.on("--reply-to ID", "Reply to a specific message ID") { |v| options[:reply_to_message_id] = v }

  opts.on("-h", "--help", "Show this help") do
    puts opts
    exit
  end
end

opt_parser.parse!

if options[:to].nil? || options[:content].nil? || (options[:subject].nil? && options[:reply_to_message_id].nil?)
  $stderr.puts "Error: Missing required parameters: to, content."
  $stderr.puts "Subject is required unless replying to a message.\n\n"
  puts opt_parser
  exit 1
end

# Interpret literal \n as actual newlines if present in content
options[:content] = options[:content].gsub("\\n", "\n")

begin
  client = ZohomailClient.client

  puts "Sending email to #{options[:to]} (format: #{options[:format]})..."
  response = client.send_email(
    to: options[:to],
    subject: options[:subject],
    content: options[:content],
    from: options[:from],
    mail_format: options[:format],
    is_draft: options[:is_draft],
    reply_to_message_id: options[:reply_to_message_id]
  )

  if response.dig("status", "description") == "success"
    if options[:is_draft]
      puts "Draft created successfully!"
    else
      puts "Email sent successfully!"
    end
    puts "Message ID: #{response.dig("data", "messageId")}"
  else
    $stderr.puts "Error sending email: #{response}"
    if response["data"] && response["data"]["moreInfo"]
      $stderr.puts "Details: #{response["data"]["moreInfo"]}"
    end
    exit 1
  end
rescue ZohomailClient::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
end
