#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"
require "dotenv"

Dotenv.load
ZohomailClient.configure do |config|
  config.client_id = ENV["ZOHOMAIL_CLIENT_ID"]
  config.client_secret = ENV["ZOHOMAIL_CLIENT_SECRET"]
  config.refresh_token = ENV["ZOHOMAIL_REFRESH_TOKEN"]
  config.user_id = ENV["ZOHOMAIL_USER_ID"]
end

if ARGV.length < 3
  $stderr.puts "Usage: zohomail-send <to> <subject> <content> [from]"
  exit 1
end

to = ARGV[0]
subject = ARGV[1]
content = ARGV[2]
from = ARGV[3]

begin
  client = ZohomailClient.client

  puts "Sending email to #{to}..."
  response = client.send_email(to: to, subject: subject, content: content, from: from)

  if response.dig("status", "description") == "success"
    puts "Email sent successfully!"
    puts "Message ID: #{response.dig("data", "messageId")}"
  else
    $stderr.puts "Error sending email: #{response}"
    if response["data"] && response["data"]["moreInfo"]
      $stderr.puts "Details: #{response["data"]["moreInfo"]}"
    end
    exit 1
  end
rescue ZohomailClient::Error => e
  $stderr.puts "Error: #{e.message}"
  exit 1
end
