#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"

Dotenv.load

grant_token = ARGV[0]
if grant_token.nil?
  puts "Usage: zohomail-auth <grant_token>"
  exit 1
end

client_id = ENV["ZOHOMAIL_CLIENT_ID"]
client_secret = ENV["ZOHOMAIL_CLIENT_SECRET"]

if client_id.nil? || client_secret.nil?
  puts "ZOHOMAIL_CLIENT_ID and ZOHOMAIL_CLIENT_SECRET must be in .env"
  exit 1
end

auth = ZohomailClient::Auth.new(client_id: client_id, client_secret: client_secret)
puts "Exchanging grant token for refresh token..."
response = auth.get_tokens_from_grant(grant_token)

if response["refresh_token"]
  puts "Successfully obtained tokens!"
  puts "Refresh Token: #{response["refresh_token"]}"

  env_path = File.expand_path(".env", Dir.pwd)
  env_content = File.read(env_path) rescue ""

  if env_content.include?("ZOHOMAIL_REFRESH_TOKEN=")
    env_content.gsub!(/ZOHOMAIL_REFRESH_TOKEN=.*/, "ZOHOMAIL_REFRESH_TOKEN=#{response["refresh_token"]}")
  else
    env_content += "\nZOHOMAIL_REFRESH_TOKEN=#{response["refresh_token"]}\n"
  end

  File.write(env_path, env_content)
  puts "Updated .env with ZOHOMAIL_REFRESH_TOKEN"
else
  puts "Error obtaining tokens: #{response}"
  exit 1
end
