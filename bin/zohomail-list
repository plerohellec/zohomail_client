#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "zohomail_client"

if ARGV[0] == "--help"
  puts "Usage: zohomail-list [limit] [folder_id]"
  puts "If folder_id is not provided, it uses ZOHOMAIL_FOLDER_ID from .env"
  exit 0
end

begin
  limit = (ARGV[0] || 10).to_i
  client = ZohomailClient.client_from_env
  folder_id = ARGV[1] || ENV["ZOHOMAIL_FOLDER_ID"]

  puts "Fetching recent emails (limit: #{limit}, folder: #{folder_id || 'all'})..."
  response = client.list_messages(limit: limit, folder_id: folder_id)

  if response["data"] && response["data"].is_a?(Array)
    puts "Recent Emails:"
    messages = response["data"].sort_by { |m| m["receivedTime"].to_i }.reverse
    messages.each do |msg|
      received_at = Time.at(msg["receivedTime"].to_i / 1000)
      puts "ID: #{msg["messageId"]}"
      puts "From: #{msg["sender"]}"
      puts "Subject: #{msg["subject"]}"
      puts "Date: #{received_at.strftime("%Y-%m-%d %H:%M:%S")}"
      puts "Folder ID: #{msg["folderId"]}"
      puts "-" * 40
    end
  else
    puts "No emails found or unexpected format."
  end
rescue ZohomailClient::Error => e
  puts "Error: #{e.message}"
  exit 1
end
